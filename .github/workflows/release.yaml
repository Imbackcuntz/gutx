name: Release Docker image
on:
  release:
    types: [released]
jobs:
  release:
    name: Docker Image version
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Grab version info
      id: tag
      run: |
        REF=${GITHUB_REF##refs/tags/}
        echo "::set-output name=version::$REF"

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        # https://github.com/docker/build-push-action/issues/761
        driver-opts:
          image=moby/buildkit:v0.10.6

    - name: Login into GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: charted-dev
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        push: true
        tags: |
          ghcr.io/charted-dev/devcontainer:${{steps.tag.outputs.version}},
- name: Git Version
  uses: codacy/git-version@2.4.0
ghcr.io/charted-dev/devcontainer:latest
- name: Setup Go environment
  uses: actions/setup-go@v3.5.0
  with:
    # The Go version to download (if necessary) and use. Supports semver spec and ranges.
    go-version: # optional
    # Path to the go.mod or go.work file.
    go-version-file: # optional
    # Set this option to true if you want the action to always check for the latest available version that satisfies the version spec
    check-latest: # optional
    # Used to pull node distributions from go-versions. Since there's a default, this is typically not supplied by the user. When running this action on github.com, the default value is sufficient. When running on GHES, you can pass a personal access token for github.com if you are experiencing rate limiting.
    token: # optional, default is ${{ github.server_url == 'https://github.com' && github.token || '' }}
    # Used to specify whether caching is needed. Set to true, if you'd like to enable caching.
    cache: # optional
    # Used to specify the path to a dependency file - go.sum
    cache-dependency-path: # optional
    # Target architecture for Go to use. Examples: x86, x64. Will use system architecture by default.
    architecture: # optional
